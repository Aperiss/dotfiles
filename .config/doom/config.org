#+TITLE: Doom Emacs Configuration
#+AUTHOR: Antonio Peris Sanchez
#+EMAIL: perissanchezantonio@gmail.com
#+PROPERTY: header-args:emacs-lisp :tangle yes :comments link

* Table of Contents :TOC:
- [[#basic-configuration][Basic Configuration]]
- [[#ui-configuration][UI Configuration]]
  - [[#window-size-and-position][Window Size and Position]]
  - [[#font][Font]]
  - [[#theme][Theme]]
  - [[#line-numbers][Line Numbers]]
- [[#editor-settings][Editor Settings]]
  - [[#scroll-offset][Scroll Offset]]
- [[#keybindings][Keybindings]]
  - [[#window-splits][Window Splits]]
  - [[#motion-and-scrolling][Motion and Scrolling]]
  - [[#editing][Editing]]
  - [[#toggles][Toggles]]
- [[#terminal-configuration][Terminal Configuration]]
  - [[#vterm][Vterm]]
- [[#environment-setup][Environment Setup]]
- [[#global-debugger-configuration][Global Debugger Configuration]]
- [[#dev-languages-configuration][Dev Languages Configuration]]
  - [[#rust][Rust]]
  - [[#c][C++]]
  - [[#c-1][C]]
  - [[#zig][Zig]]
  - [[#go][Go]]
  - [[#python][Python]]
  - [[#lua][Lua]]
- [[#org-mode][Org Mode]]
  - [[#org-directory][Org Directory]]
  - [[#org-extensions][Org Extensions]]
  - [[#org-appearance][Org Appearance]]
  - [[#org-roam-improvements][Org Roam Improvements]]
  - [[#org-roam][Org Roam]]
  - [[#org-headings][Org Headings]]
  - [[#org-navigation][Org Navigation]]
  - [[#zen-mode][Zen Mode]]
  - [[#prettier-ui-elements][Prettier UI Elements]]

* Basic Configuration

#+begin_src emacs-lisp
(setq confirm-kill-emacs nil)

(setq user-full-name "Antonio Peris Sanchez"
      user-mail-address "perissanchezantonio@gmail.com")
#+end_src

* UI Configuration
** Window Size and Position

Set initial frame size and position on startup.

#+begin_src emacs-lisp
(setq initial-frame-alist
      '((left . 1700)
        (width . 190)
        (height . 50)))
#+end_src

** Font

Using JetBrains Mono Nerd Font and Noto Sans SC for chinese characters

#+begin_src emacs-lisp
;; Main font
(setq doom-font (font-spec :family "JetBrainsMono Nerd Font" :size 14.0))

;; Chinese font for CJK characters
(add-hook 'doom-init-ui-hook
          (lambda ()
            (dolist (charset '(kana han cjk-misc bopomofo))
              (set-fontset-font t charset (font-spec :family "Noto Sans SC" :size 14.0)))))
#+end_src

** Theme

Use Catppuccin Mocha theme

#+begin_src emacs-lisp
(setq doom-theme 'catppuccin)
(setq catppuccin-flavor 'mocha)
(load-theme 'catppuccin t)
#+end_src

** Line Numbers

Enable line numbers

#+begin_src emacs-lisp
(setq display-line-numbers-type t
      display-line-numbers-width 4
      display-line-numbers-width-start nil)  ; Don't auto-calculate, always use fixed width
#+end_src

* Editor Settings

Core editor behavior and display settings.

** Scroll Offset

Keep cursor centered with scroll offset - always show context above/below and left/right of cursor.

#+begin_src emacs-lisp
(setq scroll-margin 10                  ; 10 lines above/below cursor
      scroll-conservatively 101          ; Scroll smoothly
      scroll-preserve-screen-position t  ; Keep cursor position when scrolling
      hscroll-margin 10                  ; 10 columns left/right of cursor
      hscroll-step 1)                    ; Smooth horizontal scrolling
#+end_src

* Keybindings
** Window Splits

Tmux-style window splitting with =SPC w %= and =SPC w "=
Additional bindings for closing windows.

#+begin_src emacs-lisp
(map! :leader
      :prefix "w"
      :desc "Split window right" "%" #'evil-window-vsplit
      :desc "Split window below" "\"" #'evil-window-split
      :desc "Kill window" "x" #'evil-window-delete)
#+end_src

** Motion and Scrolling

Auto-center the cursor after scrolling and searching for better visibility.

#+begin_src emacs-lisp
;; Center cursor after scrolling
(map! :n "C-d" (cmd! (evil-scroll-down 0) (evil-scroll-line-to-center (line-number-at-pos)))
      :n "C-u" (cmd! (evil-scroll-up 0) (evil-scroll-line-to-center (line-number-at-pos))))

;; Center cursor after jumping to changes
(map! :n "g," (cmd! (evil-goto-last-change) (evil-scroll-line-to-center (line-number-at-pos)))
      :n "g;" (cmd! (evil-goto-last-change-reverse) (evil-scroll-line-to-center (line-number-at-pos))))
#+end_src

** Editing

Quality of life improvements for editing and window management.

#+begin_src emacs-lisp
;; Insert blank lines without entering insert mode
(map! :n "]<SPC>" (cmd! (evil-open-below 1) (forward-line -1))
      :n "[<SPC>" (cmd! (evil-open-above 1) (forward-line 1)))

;; Resize windows with Shift + arrow keys
(map! :n "S-<up>"    (cmd! (evil-window-increase-height 2))
      :n "S-<down>"  (cmd! (evil-window-decrease-height 2))
      :n "S-<right>" (cmd! (evil-window-increase-width 2))
      :n "S-<left>"  (cmd! (evil-window-decrease-width 2)))
#+end_src

** Toggles

Toggle functions for common settings with =SPC t= prefix.

#+begin_src emacs-lisp
;; Toggle whitespace visualization
(defun my/toggle-whitespace ()
  (interactive)
  (if whitespace-mode
      (progn
        (whitespace-mode -1)
        (message "Whitespace visualization: OFF"))
    (progn
      (setq-local whitespace-style '(face tabs spaces trailing space-before-tab
                                     newline indentation empty space-after-tab
                                     space-mark tab-mark newline-mark))
      (whitespace-mode 1)
      (message "Whitespace visualization: ON"))))

(map! :leader
      :prefix "t"
      :desc "Toggle whitespace" "w" #'my/toggle-whitespace)
#+end_src

* Terminal Configuration
** Vterm

Configure vterm to work like a regular terminal (Ghostty-style) with no Evil interference.
ESC goes directly to the terminal for canceling commands, vim in terminal, etc.
C-w h/j/k/l still works for window switching.
C-a temporarily enters Evil normal mode for SPC leader commands, then press i to return to terminal.

#+begin_src emacs-lisp
(after! vterm
  ;; Disable Evil in vterm - use Emacs state (no vim bindings)
  (evil-set-initial-state 'vterm-mode 'emacs)

  ;; Send ESC directly to the terminal
  (define-key vterm-mode-map (kbd "<escape>") 'vterm-send-escape)

  ;; C-a enters Evil normal mode for leader commands
  ;; Press i or a to return to terminal input
  (define-key vterm-mode-map (kbd "C-a") 'evil-normal-state)

  ;; Keep C-w for window commands (don't send to terminal)
  (define-key vterm-mode-map (kbd "C-w") evil-window-map)

  ;; When in normal mode, pressing i or a returns to Emacs state (terminal input)
  (evil-define-key 'normal vterm-mode-map
    (kbd "i") 'evil-emacs-state
    (kbd "a") 'evil-emacs-state))
#+end_src

* Environment Setup

Sync exec-path from PATH environment variable so Emacs can find all executables.
Doom's env file sets PATH correctly, but exec-path needs to be updated from it.

#+begin_src emacs-lisp
;; Sync exec-path from PATH environment variable
;; This ensures Emacs can find all executables without hardcoding paths
(setq exec-path (append (parse-colon-path (getenv "PATH")) exec-path))
#+end_src

* Global Debugger Configuration

Global debugger configuration using dape (Debug Adapter Protocol for Emacs).

#+begin_src emacs-lisp
;; Load dape and enable global breakpoint mode
(use-package! dape
  :config
  ;; Enable global breakpoint mode so we can set breakpoints anytime
  (dape-breakpoint-global-mode +1))
#+end_src

* Dev Languages Configuration
** Rust
*** LSP Configuration
Configure rust-analyzer with clippy for enhanced linting, inlay hints, and advanced features.

#+begin_src emacs-lisp
(after! lsp-mode
  (setq lsp-rust-analyzer-cargo-watch-command "clippy"
        lsp-rust-analyzer-check-on-save-command "clippy"

        ;; Inlay hints
        lsp-rust-analyzer-server-display-inlay-hints t
        lsp-rust-analyzer-display-lifetime-elision-hints-enable "skip_trivial"
        lsp-rust-analyzer-display-chaining-hints t
        lsp-rust-analyzer-display-lifetime-elision-hints-use-parameter-names nil
        lsp-rust-analyzer-display-closure-return-type-hints t
        lsp-rust-analyzer-display-parameter-hints nil
        lsp-rust-analyzer-display-reborrow-hints nil

        ;; Cargo features
        lsp-rust-analyzer-cargo-load-out-dirs-from-check t
        lsp-rust-analyzer-cargo-all-targets t
        lsp-rust-analyzer-proc-macro-enable t

        ;; Import settings
        lsp-rust-analyzer-import-granularity "module"
        lsp-rust-analyzer-import-prefix "by-self"

        ;; Semantic highlighting - disable mutable variable underlining
        lsp-rust-analyzer-highlighting-mutable-underline nil
        lsp-rust-analyzer-highlighting-mutable-emphasis "none"))
#+end_src

*** Debugger Configuration
Configure debugging for Rust using lldb-dap.

#+begin_src emacs-lisp
(after! dape
  (add-to-list 'dape-configs
               `(rust-lldb
                 modes (rust-mode rust-ts-mode)
                 command ,(or (executable-find "lldb-dap") "lldb-dap")
                 command-args ()
                 fn (lambda (config)
                      (plist-put config :program
                                (let ((root (dape--guess-root config)))
                                  (read-file-name "Rust binary to debug: "
                                                (file-name-concat root "target/debug/"))))
                      config)
                 :type "lldb"
                 :request "launch"
                 :cwd dape-cwd-fn
                 :program ""
                 :args []
                 :stopOnEntry nil)))
#+end_src

** C++
*** LSP Configuration
Configure clangd for C++ development with inlay hints and advanced features.

#+begin_src emacs-lisp
(after! lsp-mode
  (setq lsp-clients-clangd-args '("-j=4"
                                  "--background-index"
                                  "--clang-tidy"
                                  "--completion-style=detailed"
                                  "--header-insertion=never"
                                  "--header-insertion-decorators=0"
                                  "--pch-storage=memory"
                                  "--enable-config"
                                  "--function-arg-placeholders"
                                  "--all-scopes-completion"
                                  "--cross-file-rename")))

;; Enable inlay hints for C++ (if using lsp-mode with inlay hint support)
(after! lsp-mode
  (setq lsp-inlay-hint-enable t))
#+end_src

*** Debugger Configuration
Configure debugging for C++ using lldb-dap.

#+begin_src emacs-lisp
(after! dape
  (add-to-list 'dape-configs
               `(cpp-lldb
                 modes (c++-mode c++-ts-mode)
                 command ,(or (executable-find "lldb-dap") "lldb-dap")
                 command-args ()
                 fn (lambda (config)
                      (plist-put config :program
                                (read-file-name "C++ binary to debug: "
                                              (dape--guess-root config)))
                      config)
                 :type "lldb"
                 :request "launch"
                 :cwd dape-cwd-fn
                 :program ""
                 :args []
                 :stopOnEntry nil)))
#+end_src

** C
*** LSP Configuration
Configure clangd for C development with inlay hints and advanced features.
Uses the same clangd configuration as C++.

*** Debugger Configuration
Configure debugging for C using lldb-dap.

#+begin_src emacs-lisp
(after! dape
  (add-to-list 'dape-configs
               `(c-lldb
                 modes (c-mode c-ts-mode)
                 command ,(or (executable-find "lldb-dap") "lldb-dap")
                 command-args ()
                 fn (lambda (config)
                      (plist-put config :program
                                (read-file-name "C binary to debug: "
                                              (dape--guess-root config)))
                      config)
                 :type "lldb"
                 :request "launch"
                 :cwd dape-cwd-fn
                 :program ""
                 :args []
                 :stopOnEntry nil)))
#+end_src

** Zig
*** LSP Configuration
Configure ZLS (Zig Language Server) with semantic tokens and advanced features.
The (zig +lsp) module automatically handles zls startup - zls is found via PATH.

#+begin_src emacs-lisp
(after! lsp-zig
  ;; ZLS will be found automatically via PATH
  (setq lsp-zig-enable-inlay-hints t
        lsp-zig-enable-autofix t))

;; Enable inlay hints for Zig (LSP is already enabled by +lsp module)
(after! zig-mode
  (add-hook 'zig-mode-hook #'lsp-inlay-hints-mode))
#+end_src

*** Debugger Configuration
Configure debugging for Zig using lldb-dap.

#+begin_src emacs-lisp
(after! dape
  (add-to-list 'dape-configs
               `(zig-lldb
                 modes (zig-mode zig-ts-mode)
                 command ,(or (executable-find "lldb-dap") "lldb-dap")
                 command-args ()
                 fn (lambda (config)
                      (plist-put config :program
                                (let ((root (dape--guess-root config)))
                                  (read-file-name "Zig binary to debug: "
                                                (file-name-concat root "zig-out/bin/"))))
                      config)
                 :type "lldb"
                 :request "launch"
                 :cwd dape-cwd-fn
                 :program ""
                 :args []
                 :stopOnEntry nil)))
#+end_src

** Go
*** LSP Configuration
Configure gopls with inlay hints and static analysis.

#+begin_src emacs-lisp
(after! lsp-mode
  (setq lsp-go-analyses '((nilness . t)
                          (unusedparams . t)
                          (unusedwrite . t)
                          (useany . t))
        lsp-go-codelenses '((generate . t)
                            (test . t)
                            (tidy . t)
                            (upgrade_dependency . t)
                            (vendor . t))
        lsp-go-use-gofumpt t
        lsp-go-hints '((assignVariableTypes . t)
                       (compositeLiteralFields . t)
                       (compositeLiteralTypes . t)
                       (constantValues . t)
                       (functionTypeParameters . t)
                       (parameterNames . t)
                       (rangeVariableTypes . t))))
#+end_src

*** Debugger Configuration
Configure debugging for Go using Delve (dlv) in DAP mode.
Three configurations for different debugging modes:
- dlv-debug: Compile and debug Go source code
- dlv-exec: Debug a pre-compiled binary
- dlv-test: Debug Go tests

#+begin_src emacs-lisp
(after! dape
  ;; 1. Debug mode: Compile and debug source code
  (add-to-list 'dape-configs
               `(dlv-debug
                 modes (go-mode go-ts-mode)
                 ensure dape-ensure-command
                 command "dlv"
                 command-args ("dap" "--listen" "127.0.0.1::autoport")
                 command-insert-stderr t
                 port :autoport
                 fn (lambda (config)
                      (let* ((root (dape--guess-root config))
                             (default-dir (if (file-exists-p (concat root "cmd/"))
                                            (concat root "cmd/")
                                            root))
                             (selected-path (read-directory-name "Go package to debug: " default-dir)))
                        (plist-put config :program
                                  (expand-file-name selected-path)))
                      config)
                 :type "go"
                 :request "launch"
                 :mode "debug"
                 :cwd dape-cwd-fn
                 :program ""
                 :args []))

  ;; 2. Exec mode: Debug pre-compiled binary
  (add-to-list 'dape-configs
               `(dlv-exec
                 modes (go-mode go-ts-mode)
                 ensure dape-ensure-command
                 command "dlv"
                 command-args ("dap" "--listen" "127.0.0.1::autoport")
                 command-insert-stderr t
                 port :autoport
                 fn (lambda (config)
                      (let* ((root (dape--guess-root config))
                             (default-dir (if (file-exists-p (concat root "build/"))
                                            (concat root "build/")
                                            root))
                             (selected-binary (read-file-name "Go binary to debug: " default-dir)))
                        (plist-put config :program
                                  (expand-file-name selected-binary)))
                      config)
                 :type "go"
                 :request "launch"
                 :mode "exec"
                 :cwd dape-cwd-fn
                 :program ""
                 :args []))

  ;; 3. Test mode: Debug Go tests
  (add-to-list 'dape-configs
               `(dlv-test
                 modes (go-mode go-ts-mode)
                 ensure dape-ensure-command
                 command "dlv"
                 command-args ("dap" "--listen" "127.0.0.1::autoport")
                 command-insert-stderr t
                 port :autoport
                 fn (lambda (config)
                      (plist-put config :program
                                (file-name-directory (buffer-file-name)))
                      config)
                 :type "go"
                 :request "launch"
                 :mode "test"
                 :cwd dape-cwd-fn
                 :program ""
                 :args [])))
#+end_src

** Python
*** LSP Configuration
Configure Python with dual LSP setup: Pyright for type checking and Ruff for fast linting.

#+begin_src emacs-lisp
(after! lsp-mode
  ;; Load Pyright LSP client
  (require 'lsp-pyright)

  ;; Pyright configuration - type checking and completions
  (setq lsp-pyright-typechecking-mode "basic"
        lsp-pyright-disable-organize-imports nil

        ;; Auto-import and completions
        lsp-pyright-auto-import-completions t
        lsp-pyright-use-library-code-for-types t

        ;; Diagnostics
        lsp-pyright-diagnostic-mode "workspace"

        ;; Virtual environment support
        lsp-pyright-venv-path (expand-file-name "~/.virtualenvs")))

;; Python-specific: enable inlay hints
(after! python-mode
  (add-hook 'python-mode-hook #'lsp-inlay-hints-mode))
#+end_src

*** Debugger Configuration
Configure debugging for Python using debugpy (Python's Debug Adapter Protocol).

#+begin_src emacs-lisp
(after! dape
  (add-to-list 'dape-configs
               `(debugpy
                 modes (python-mode python-ts-mode)
                 ensure dape-ensure-command
                 command "python3"
                 command-args ("-m" "debugpy.adapter")
                 fn (lambda (config)
                      (let* ((current-dir (file-name-directory (buffer-file-name)))
                             (selected-file (read-file-name "Python file to run: " current-dir)))
                        (plist-put config :program (expand-file-name selected-file)))
                      config)
                 :request "launch"
                 :type "executable"
                 :cwd dape-cwd-fn
                 :program ""
                 :args [])))
#+end_src

** Lua
*** LSP Configuration
Configure lua-language-server with inlay hints, runtime version, and diagnostics.

#+begin_src emacs-lisp
(after! lsp-mode
  (setq lsp-lua-hint-enable t
        lsp-lua-hint-set-type t
        lsp-lua-hint-param-type t

        ;; Runtime configuration
        lsp-lua-runtime-version "LuaJIT"

        ;; Completion
        lsp-lua-completion-call-snippet "Both"
        lsp-lua-completion-keyword-snippet "Both"

        ;; Diagnostics
        lsp-lua-diagnostics-enable t
        lsp-lua-diagnostics-globals '("vim")  ; If using Neovim Lua API

        ;; Semantic highlighting
        lsp-semantic-tokens-enable t))
#+end_src
* Org Mode
** Org Directory
Set the base directory for org files.

#+begin_src emacs-lisp
(setq org-directory "~/Org/org/")
(add-hook 'org-mode-hook #'hl-todo-mode)
#+end_src

** Org Extensions
General-purpose org-mode extensions for enhanced functionality.

*** Org-QL
Advanced query language for searching and filtering org notes.

#+begin_src emacs-lisp
(use-package! org-ql
  :after org)
#+end_src

*** Org-Transclusion
Embed content from one org file into another, creating live references.

#+begin_src emacs-lisp
(use-package! org-transclusion
  :after org
  :config
  (add-hook 'org-mode-hook #'org-transclusion-mode))
#+end_src

*** Org-Super-Agenda
Group and organize agenda items by custom criteria (tags, priorities, etc.).

#+begin_src emacs-lisp
(use-package! org-super-agenda
  :after org-agenda
  :config
  (org-super-agenda-mode))
#+end_src

** Org Appearance
Modern note-taking appearance for org-mode

#+begin_src emacs-lisp
;; Set fonts for org-mode - use JetBrains Mono for everything
(add-hook 'org-mode-hook
          (lambda ()
            ;; Enable visual line mode for better text wrapping
            (visual-line-mode 1)
            ;; Softer line spacing
            (setq-local line-spacing 0.2)))

;; Readable line length - centers text with comfortable max width
(setq-default fill-column 80)  ; Max line width for readability

;; Keep code blocks, tables, and tags monospaced for alignment
(custom-set-faces!
  '(org-code :inherit (shadow fixed-pitch) :family "JetBrainsMono Nerd Font" :height 0.9)
  '(org-block :inherit fixed-pitch :family "JetBrainsMono Nerd Font" :height 0.9)
  '(org-table :inherit fixed-pitch :family "JetBrainsMono Nerd Font" :height 0.9)
  '(org-verbatim :inherit (shadow fixed-pitch) :family "JetBrainsMono Nerd Font" :height 0.9)
  '(org-special-keyword :inherit (font-lock-comment-face fixed-pitch) :family "JetBrainsMono Nerd Font" :height 0.9)
  '(org-meta-line :inherit (font-lock-comment-face fixed-pitch) :family "JetBrainsMono Nerd Font" :height 0.9)
  '(org-checkbox :inherit fixed-pitch :family "JetBrainsMono Nerd Font")
  '(org-tag :inherit (shadow fixed-pitch) :family "JetBrainsMono Nerd Font" :height 0.8))

;; Modern visual enhancements
(setq org-hide-emphasis-markers t        ; Hide markup characters like *bold*
      org-pretty-entities t              ; Show UTF8 characters for \alpha etc
      org-ellipsis " ▾"                  ; Nicer folding symbol
      org-hide-leading-stars t           ; Cleaner heading bullets
      org-startup-indented t             ; Indent content under headings
      org-adapt-indentation nil)         ; Don't indent content when promoting/demoting

;; Better list bullets
(after! org
  (setq org-list-demote-modify-bullet '(("+" . "-") ("-" . "+") ("*" . "+")))

  ;; Org modern bullets for headings (using org-superstar from Doom)
  (setq org-superstar-headline-bullets-list '("◉" "○" "●" "○" "●" "○" "●"))

  ;; Pretty checkboxes using org-superstar
  (setq org-superstar-item-bullet-alist
        '((?* . ?•)
          (?+ . ?◦)
          (?- . ?▸))))

;; Hide unnecessary org markup elements for cleaner look
(setq org-hidden-keywords '(title))      ; Hide #+title:

;; Make links more readable - show only description
(setq org-link-descriptive t)

;; Better source block appearance
(setq org-src-fontify-natively t         ; Syntax highlighting in code blocks
      org-src-tab-acts-natively t        ; Tab works normally in code blocks
      org-src-preserve-indentation t)    ; Keep indentation in code blocks
#+end_src

** Org Roam Improvements

#+begin_src emacs-lisp
(setq +org-roam-auto-backlinks-buffer nil)  ; Manually toggle backlinks buffer with SPC n r r

;; Enhanced search in org-roam with tag display
(after! org-roam
  ;; Better node search with previews and tags
  (setq org-roam-node-display-template
        (concat "${title:*} "
                (propertize "${tags:10}" 'face 'org-tag)))

  ;; Enable completion everywhere for [[links]]
  (setq org-roam-completion-everywhere t))

;; Link preview on hover (eldoc shows link destinations)
(setq eldoc-echo-area-use-multiline-p nil)
(add-hook 'org-mode-hook #'eldoc-mode)

;; Better link following - preview before opening
(setq org-return-follows-link nil)  ; Prevent accidental link following with RET
#+end_src

** Org Roam
Configuration for org-roam note-taking system.

#+begin_src emacs-lisp
(use-package! org-roam
  :after org
  :init
  (setq org-roam-v2-ack t)
  :custom
  (org-roam-directory "~/Org/org-roam")
  (org-roam-completion-everywhere t)  ; Enable completion when typing [[...]]
  :config
  (org-roam-db-autosync-enable))

;; Make fuzzy links [[Title]] search org-roam database and convert to ID links
(after! org-roam
  (defun my/org-roam-resolve-fuzzy-link (orig-fn s &optional avoid-pos stealth)
    "Advise org-link-search to check org-roam first and convert fuzzy links to ID links.
If the node doesn't exist, create it via org-roam-capture."
    ;; First check if org-roam has a node with this title
    (if-let ((node (org-roam-node-from-title-or-alias s)))
        (progn
          ;; Convert the fuzzy link to an ID link
          (when (and (not stealth) (org-in-regexp org-link-bracket-re))
            (let* ((link-start (match-beginning 0))
                   (link-end (match-end 0))
                   (id (org-roam-node-id node)))
              (save-excursion
                (goto-char link-start)
                (delete-region link-start link-end)
                (insert (format "[[id:%s][%s]]" id s)))
              ;; Auto-save after converting the link
              (save-buffer)))
          ;; Visit the node
          (org-roam-node-visit node))
      ;; Node doesn't exist - create it via org-roam-capture
      (let* ((title s)
             (source-buffer (current-buffer))
             (link-start nil)
             (link-end nil))
        ;; Save link position if we're at a link
        (when (and (not stealth) (org-in-regexp org-link-bracket-re))
          (setq link-start (match-beginning 0)
                link-end (match-end 0)))

        ;; Add a one-time hook to convert the link after capture finishes
        (when link-start
          (letrec ((convert-link-fn
                    (lambda ()
                      ;; This runs after capture is finalized (whether completed or aborted)
                      ;; Force database sync for the current file if it exists
                      (when (and (buffer-file-name) (file-exists-p (buffer-file-name)))
                        (org-roam-db-update-file (buffer-file-name)))
                      ;; Small delay to ensure database is updated
                      (run-at-time
                       0.1 nil
                       (lambda ()
                         ;; Check if the node was actually created by looking it up in the database
                         (when-let ((new-node (org-roam-node-from-title-or-alias title)))
                           (let ((id (org-roam-node-id new-node)))
                             ;; Switch back to source buffer and convert the link
                             (when (buffer-live-p source-buffer)
                               (with-current-buffer source-buffer
                                 (save-excursion
                                   (goto-char link-start)
                                   (when (< link-start (point-max))
                                     (delete-region link-start link-end)
                                     (insert (format "[[id:%s][%s]]" id title))))
                                 ;; Auto-save the buffer after converting the link
                                 (save-buffer)))))
                         ;; Remove this hook after running
                         (remove-hook 'org-capture-after-finalize-hook convert-link-fn))))))
            (add-hook 'org-capture-after-finalize-hook convert-link-fn)))

        ;; Trigger org-roam capture with the title
        (org-roam-capture- :node (org-roam-node-create :title title)
                           :props '(:finalize find-file)))))

  (advice-add 'org-link-search :around #'my/org-roam-resolve-fuzzy-link))

;; Dead links - simple command approach
(defun my/org-roam-show-dead-links ()
  "Show all dead links (fuzzy links with no matching nodes) in current buffer."
  (interactive)
  (let ((dead-links '()))
    (save-excursion
      (goto-char (point-min))
      (while (re-search-forward org-link-bracket-re nil t)
        (let* ((path (match-string 1)))
          ;; Check if it's a fuzzy link (no type prefix like "id:" or "file:")
          (when (not (string-match-p ":" path))
            (unless (org-roam-node-from-title-or-alias path)
              (push path dead-links))))))
    (if dead-links
        (message "Dead links: %s" (string-join (seq-uniq dead-links) ", "))
      (message "No dead links found"))))

;; Dead links section for org-roam buffer
(defun org-roam-buffer-dead-links-section (node)
  "Section showing dead links for NODE in org-roam buffer."
  (when-let ((file (org-roam-node-file node)))
    (when (file-exists-p file)
      (let ((dead-links '()))
        (with-current-buffer (or (find-buffer-visiting file)
                                  (find-file-noselect file))
          (save-excursion
            (goto-char (point-min))
            (while (re-search-forward org-link-bracket-re nil t)
              (let* ((path (match-string 1)))
                ;; Check if it's a fuzzy link (no type prefix like "id:" or "file:")
                (when (not (string-match-p ":" path))
                  (unless (org-roam-node-from-title-or-alias path)
                    (push path dead-links)))))))
        ;; Always insert section to test if function is being called
        (magit-insert-section (org-roam-dead-links)
          (magit-insert-heading "Dead Links:")
          (if dead-links
              (dolist (link (seq-uniq dead-links))
                (insert (format "  %s\n" link)))
            (insert "  No dead links found.\n"))
          (insert "\n"))))))

(after! org-roam
  ;; Add dead links section to org-roam buffer - set explicitly
  (setq org-roam-mode-sections
        (list #'org-roam-backlinks-section
              #'org-roam-reflinks-section
              #'org-roam-unlinked-references-section
              #'org-roam-buffer-dead-links-section)))

(map! :after org-roam
      :map org-mode-map
      :localleader
      :prefix ("r" . "roam")
      :desc "Show dead links" "d" #'my/org-roam-show-dead-links)
#+end_src

*** Org Roam UI
Interactive graph visualization in browser with keybinding.

#+begin_src emacs-lisp
(use-package! org-roam-ui
  :after org-roam
  :config
  (setq org-roam-ui-sync-theme t
        org-roam-ui-follow t
        org-roam-ui-update-on-save t
        org-roam-ui-open-on-start nil
        org-roam-ui-custom-theme nil  ; Let it auto-sync from Emacs theme
        org-roam-ui-browser-function #'browse-url)

  ;; Replace org-roam-graph with org-roam-ui-mode
  (defalias 'org-roam-graph 'org-roam-ui-mode
    "Use org-roam-ui instead of default graph"))

;; Override the default graph keybinding - set after org-roam loads
(after! org-roam
  ;; Override both the command and the which-key description
  (map! :leader
        (:prefix ("n" . "notes")
         (:prefix ("r" . "roam")
          :desc "Toggle org-roam-ui" "g" #'org-roam-ui-mode))))
#+end_src

*** TTRPG Notes Configuration
TTRPG-specific org-roam enhancements for managing adventures, worldbuilding, and system references.

Directory structure (in sort order):
- =0_inbox/= - Uncategorized notes to organize later
- =1_adventures/= - Campaign/adventure-specific content
  - Each adventure contains: sessions/, characters/, locations/, story/, prep/
  - =z_meta/= - Adventure-specific assets (PDFs, maps, images, handouts)
- =2_worlds/= - Shared worldbuilding across adventures
- =3_systems/= - Game system rules, monsters, spells, references
- =4_other/= - GM tips, generators, ideas, misc
- =z_meta/= - Shared templates and general GM resources

**** TTRPG Context System
Context variables to remember current working world/adventure/system during a session.
Set once, create many notes without repeated prompts.

#+begin_src emacs-lisp
;; Context variables (session-scoped)
(defvar my/ttrpg-current-world nil "Current working world context")
(defvar my/ttrpg-current-adventure nil "Current working adventure context")
(defvar my/ttrpg-current-system nil "Current working system context")

;; Helper functions to list existing content
(defun my/ttrpg-list-worlds ()
  "Return list of existing world directory names."
  (let ((worlds-dir (expand-file-name "~/Org/org-roam/ttrpg/2_worlds/")))
    (when (file-directory-p worlds-dir)
      (seq-filter (lambda (dir)
                    (and (not (string-prefix-p "." dir))
                         (file-directory-p (expand-file-name dir worlds-dir))))
                  (directory-files worlds-dir nil)))))

(defun my/ttrpg-list-adventures ()
  "Return list of existing adventure directory names."
  (let ((adventures-dir (expand-file-name "~/Org/org-roam/ttrpg/1_adventures/")))
    (when (file-directory-p adventures-dir)
      (seq-filter (lambda (dir)
                    (and (not (string-prefix-p "." dir))
                         (file-directory-p (expand-file-name dir adventures-dir))))
                  (directory-files adventures-dir nil)))))

(defun my/ttrpg-list-systems ()
  "Return list of existing system directory names."
  (let ((systems-dir (expand-file-name "~/Org/org-roam/ttrpg/3_systems/")))
    (when (file-directory-p systems-dir)
      (seq-filter (lambda (dir)
                    (and (not (string-prefix-p "." dir))
                         (file-directory-p (expand-file-name dir systems-dir))))
                  (directory-files systems-dir nil)))))

;; Context management commands
(defun my/ttrpg-set-world ()
  "Set current world context from existing worlds."
  (interactive)
  (let ((worlds (my/ttrpg-list-worlds)))
    (if worlds
        (progn
          (setq my/ttrpg-current-world
                (completing-read "Set world context: " worlds nil t))
          (message "World context set to: %s" my/ttrpg-current-world))
      (message "No worlds found. Create one with SPC n r f → tww"))))

(defun my/ttrpg-set-adventure ()
  "Set current adventure context from existing adventures."
  (interactive)
  (let ((adventures (my/ttrpg-list-adventures)))
    (if adventures
        (progn
          (setq my/ttrpg-current-adventure
                (completing-read "Set adventure context: " adventures nil t))
          (message "Adventure context set to: %s" my/ttrpg-current-adventure))
      (message "No adventures found. Create one with SPC n r f → taa"))))

(defun my/ttrpg-set-system ()
  "Set current system context from existing systems."
  (interactive)
  (let ((systems (my/ttrpg-list-systems)))
    (if systems
        (progn
          (setq my/ttrpg-current-system
                (completing-read "Set system context: " systems nil t))
          (message "System context set to: %s" my/ttrpg-current-system))
      (message "No systems found."))))

(defun my/ttrpg-clear-context ()
  "Clear all TTRPG context variables."
  (interactive)
  (setq my/ttrpg-current-world nil
        my/ttrpg-current-adventure nil
        my/ttrpg-current-system nil)
  (message "TTRPG context cleared"))

(defun my/ttrpg-show-context ()
  "Display current TTRPG context."
  (interactive)
  (message "Current context: World=%s, Adventure=%s, System=%s"
           (or my/ttrpg-current-world "none")
           (or my/ttrpg-current-adventure "none")
           (or my/ttrpg-current-system "none")))

;; Helper to get or prompt for context
(defun my/ttrpg-get-world ()
  "Get current world or prompt with completion."
  (or my/ttrpg-current-world
      (let ((worlds (my/ttrpg-list-worlds)))
        (when worlds
          (setq my/ttrpg-current-world
                (completing-read "World: " worlds nil t))))))

(defun my/ttrpg-get-adventure ()
  "Get current adventure or prompt with completion."
  (or my/ttrpg-current-adventure
      (let ((adventures (my/ttrpg-list-adventures)))
        (when adventures
          (setq my/ttrpg-current-adventure
                (completing-read "Adventure: " adventures nil t))))))

(defun my/ttrpg-get-system ()
  "Get current system or prompt with completion."
  (or my/ttrpg-current-system
      (let ((systems (my/ttrpg-list-systems)))
        (when systems
          (setq my/ttrpg-current-system
                (completing-read "System: " systems nil t))))))
#+end_src

**** TTRPG Capture Templates

Templates are stored as files in =ttrpg/z_meta/templates/= for easy editing.
Edit the template files directly to customize note structures.
Access via =SPC n r f= (creates new node with template selection).

#+begin_src emacs-lisp
(after! org-roam
  (setq org-roam-capture-templates
        '(("d" "default" plain "%?"
           :target (file+head "%<%Y%m%d%H%M%S>-${slug}.org"
                              "#+title: ${title}\n")
           :unnarrowed t)

          ;; TTRPG Root Menu
          ("t" "TTRPG")

          ;; Adventures (ta submenu)
          ("ta" "Adventure")

          ("taa" "Adventure Homepage" plain
           (file "~/Org/org-roam/ttrpg/z_meta/templates/adventure.org")
           :target (file+head "ttrpg/1_adventures/${slug}/${slug}.org"
                              "#+title: ${title}\n#+filetags: :adventure:homepage:\n#+created: %<%Y-%m-%d>\n:PROPERTIES:\n:adventure_type: \n:world: \n:system: \n:status: \n:END:\n\n")
           :unnarrowed t)

          ("tas" "Adventure Session" plain
           (file "~/Org/org-roam/ttrpg/z_meta/templates/session.org")
           :target (file+head "ttrpg/1_adventures/%(my/ttrpg-get-adventure)/sessions/${slug}.org"
                              "#+title: ${title}\n#+filetags: :adventure:session:%(my/ttrpg-get-adventure):\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("tac" "Adventure Character" plain
           (file "~/Org/org-roam/ttrpg/z_meta/templates/npc.org")
           :target (file+head "ttrpg/1_adventures/%(my/ttrpg-get-adventure)/characters/${slug}.org"
                              "#+title: ${title}\n#+filetags: :adventure:character:%(my/ttrpg-get-adventure):\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("tal" "Adventure Location" plain
           (file "~/Org/org-roam/ttrpg/z_meta/templates/location.org")
           :target (file+head "ttrpg/1_adventures/%(my/ttrpg-get-adventure)/locations/${slug}.org"
                              ":PROPERTIES:\n:LOCATION_TYPE: %^{Location Type|continent|nation|region|city|town|settlement|landmark|dungeon|building}\n:END:\n#+title: ${title}\n#+filetags: :adventure:location:%(my/ttrpg-get-adventure):\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("tat" "Adventure Story Notes" plain "%?"
           :target (file+head "ttrpg/1_adventures/%(my/ttrpg-get-adventure)/story_notes/${slug}.org"
                              "#+title: ${title}\n#+filetags: :adventure:story:%(my/ttrpg-get-adventure):\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("tao" "Adventure Other" plain "%?"
           :target (file+head "ttrpg/1_adventures/%(my/ttrpg-get-adventure)/other/${slug}.org"
                              "#+title: ${title}\n#+filetags: :adventure:other:%(my/ttrpg-get-adventure):\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ;; Worlds (tw submenu)
          ("tw" "World")

          ("tww" "World Homepage" plain
           (file "~/Org/org-roam/ttrpg/z_meta/templates/world.org")
           :target (file+head "ttrpg/2_worlds/${slug}/${slug}.org"
                              "#+title: ${title}\n#+filetags: :world:homepage:\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("twc" "World Character" plain "%?"
           :target (file+head "ttrpg/2_worlds/%(my/ttrpg-get-world)/characters/${slug}.org"
                              "#+title: ${title}\n#+filetags: :world:character:%(my/ttrpg-get-world):\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("twl" "World Location" plain "%?"
           :target (file+head "ttrpg/2_worlds/%(my/ttrpg-get-world)/locations/${slug}.org"
                              ":PROPERTIES:\n:LOCATION_TYPE: %^{Location Type|continent|nation|region|city|town|settlement|landmark}\n:END:\n#+title: ${title}\n#+filetags: :world:location:%(my/ttrpg-get-world):\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("twp" "World Peoples & Cultures" plain "%?"
           :target (file+head "ttrpg/2_worlds/%(my/ttrpg-get-world)/peoples_cultures/${slug}.org"
                              "#+title: ${title}\n#+filetags: :world:culture:%(my/ttrpg-get-world):\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("twe" "World Events & History" plain "%?"
           :target (file+head "ttrpg/2_worlds/%(my/ttrpg-get-world)/events_history/${slug}.org"
                              "#+title: ${title}\n#+filetags: :world:event:%(my/ttrpg-get-world):\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("twf" "World Organizations & Factions" plain "%?"
           :target (file+head "ttrpg/2_worlds/%(my/ttrpg-get-world)/organizations_factions/${slug}.org"
                              "#+title: ${title}\n#+filetags: :world:organization:%(my/ttrpg-get-world):\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("tws" "World Systems" plain "%?"
           :target (file+head "ttrpg/2_worlds/%(my/ttrpg-get-world)/systems/${slug}.org"
                              "#+title: ${title}\n#+filetags: :world:worldsystem:%(my/ttrpg-get-world):\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("twx" "World Other" plain "%?"
           :target (file+head "ttrpg/2_worlds/%(my/ttrpg-get-world)/other/${slug}.org"
                              "#+title: ${title}\n#+filetags: :world:other:%(my/ttrpg-get-world):\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ;; Systems (ts submenu - flexible per-system structure)
          ;; Structure is NOT hardcoded since each system differs:
          ;;   PF2e: character_options/, spells_rituals/, equipment/, rules/
          ;;   FATE: aspects/, stunts/, skills/
          ;;   Daggerheart: moves/, domains/, adversaries/
          ;; Workflow: Create system homepage, add notes to 0_inbox/, organize manually later
          ;; Use tags for metadata: :homebrew:, :player_core:, :lost_omens_*, etc.
          ("ts" "System")

          ("tss" "System Homepage" plain
           (file "~/Org/org-roam/ttrpg/z_meta/templates/system.org")
           :target (file+head "ttrpg/3_systems/${slug}/${slug}.org"
                              "#+title: ${title}\n#+filetags: :system:${slug}:\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ("tsi" "System Note" plain "%?"
           :target (file+head "ttrpg/3_systems/%(my/ttrpg-get-system)/0_inbox/${slug}.org"
                              "#+title: ${title}\n#+filetags: :system:%(my/ttrpg-get-system):\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ;; Other
          ("to" "Other/Misc" plain "%?"
           :target (file+head "ttrpg/4_other/${slug}.org"
                              "#+title: ${title}\n#+filetags: :other:\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t)

          ;; Quick Inbox
          ("ti" "Inbox" plain "%?"
           :target (file+head "ttrpg/0_inbox/inbox-%<%Y%m%d-%H%M%S>.org"
                              "#+title: Inbox Note %<%Y-%m-%d %H:%M:%S>\n#+filetags: :inbox:\n#+created: %<%Y-%m-%d>\n\n")
           :unnarrowed t))))

;; Keep the quick inbox function for SPC n r I shortcut
(defun my/org-roam-capture-inbox ()
  "Create a quick note in the TTRPG inbox."
  (interactive)
  (org-roam-capture- :node (org-roam-node-create)
                     :keys "ti"))

;; TTRPG context management keybindings
(map! :leader
      (:prefix ("n" . "notes")
       (:prefix ("r" . "roam")
        :desc "Capture to inbox" "I" #'my/org-roam-capture-inbox
        (:prefix ("t" . "ttrpg context")
         :desc "Set world" "w" #'my/ttrpg-set-world
         :desc "Set adventure" "a" #'my/ttrpg-set-adventure
         :desc "Set system" "s" #'my/ttrpg-set-system
         :desc "Clear context" "c" #'my/ttrpg-clear-context
         :desc "Show context" "?" #'my/ttrpg-show-context))))
#+end_src

** Org Headings
Scale org headings for better visual hierarchy in documents.
Inspired by Nicolas Rougier's minimal aesthetic.

#+begin_src emacs-lisp
(custom-theme-set-faces!
  'doom-one
  ;; More subtle heading sizes for cleaner look
  '(org-level-8 :inherit outline-8 :height 1.0 :weight normal)
  '(org-level-7 :inherit outline-7 :height 1.0 :weight normal)
  '(org-level-6 :inherit outline-6 :height 1.05 :weight normal)
  '(org-level-5 :inherit outline-5 :height 1.1 :weight normal)
  '(org-level-4 :inherit outline-4 :height 1.15 :weight semi-bold)
  '(org-level-3 :inherit outline-3 :height 1.2 :weight semi-bold)
  '(org-level-2 :inherit outline-2 :height 1.3 :weight bold)
  '(org-level-1 :inherit outline-1 :height 1.4 :weight bold)
  ;; Cleaner document title - less overwhelming
  '(org-document-title :height 1.6 :weight bold :underline nil)
  ;; Subtle, clean links
  '(org-link :underline nil :weight normal)
  ;; Dimmed metadata
  '(org-meta-line :inherit font-lock-comment-face :height 0.85)
  '(org-special-keyword :inherit font-lock-comment-face :height 0.85)
  ;; Cleaner tags
  '(org-tag :height 0.8 :weight normal))
#+end_src

** Org Navigation
Make j/k move by visual lines instead of logical lines for better navigation with wrapped text.

#+begin_src emacs-lisp
(after! evil-org
  (evil-define-key 'normal org-mode-map
    (kbd "j") 'evil-next-visual-line
    (kbd "k") 'evil-previous-visual-line))

;; Surround word with org link brackets using M-[
(defun my/org-surround-with-link ()
  "Surround word at point or selection with [[ ]]."
  (interactive)
  (let ((bounds (if (region-active-p)
                    (cons (region-beginning) (region-end))
                  (bounds-of-thing-at-point 'word))))
    (when bounds
      (save-excursion
        (goto-char (cdr bounds))
        (insert "]]")
        (goto-char (car bounds))
        (insert "[[")))))

;; Remove surrounding org link brackets using M-]
(defun my/org-remove-link-brackets ()
  "Remove [[ ]] surrounding word at point or selection."
  (interactive)
  (save-excursion
    (let ((bounds (if (region-active-p)
                      (cons (region-beginning) (region-end))
                    (bounds-of-thing-at-point 'word))))
      (when bounds
        ;; Search backward for [[
        (goto-char (car bounds))
        (when (search-backward "[[" (line-beginning-position) t)
          (delete-char 2)
          (setq bounds (cons (- (car bounds) 2) (- (cdr bounds) 2))))
        ;; Search forward for ]]
        (goto-char (cdr bounds))
        (when (search-forward "]]" (line-end-position) t)
          (delete-char -2))))))

(map! :map org-mode-map
      :n "M-[" #'my/org-surround-with-link
      :v "M-[" #'my/org-surround-with-link
      :n "M-]" #'my/org-remove-link-brackets
      :v "M-]" #'my/org-remove-link-brackets)
#+end_src

** Zen Mode
Enhanced zen mode configuration for distraction-free writing in org-mode.
TTRPG notes automatically open in zen mode.

#+begin_src emacs-lisp
;; Zen mode configuration
(after! writeroom-mode
  ;; Don't restore window config - prevents closing other windows
  (setq writeroom-restore-window-config nil)
  ;; Disable Doom's automatic text scaling in zen mode
  (setq +zen-text-scale 0)
  ;; Disable Doom's mixed-pitch in zen mode
  (setq +zen-mixed-pitch-modes nil)
  ;; Set the width to 80 characters
  (setq writeroom-width 80))

;; Set font and width before writeroom calculates margins
(defun my/set-zen-font-before-writeroom (orig-fun &rest args)
  "Set font before writeroom-mode calculates margins."
  (when (and (not writeroom-mode)  ; Only when enabling
             (derived-mode-p 'org-mode))
    ;; Set font to JetBrains Mono 16pt BEFORE writeroom runs
    (setq-local face-remapping-alist
                '((default :family "JetBrainsMono Nerd Font" :height 160)))
    ;; Disable mixed-pitch modes
    (when (fboundp 'mixed-pitch-mode)
      (mixed-pitch-mode -1))
    (variable-pitch-mode -1)
    ;; Force redisplay so font metrics are updated
    (redisplay t))
  ;; Call the original writeroom-mode function
  (apply orig-fun args)
  ;; Fix width calculation after writeroom runs
  (when (and writeroom-mode (derived-mode-p 'org-mode))
    (setq-local visual-fill-column-width 80)
    (setq-local visual-fill-column-extra-text-width '(0 . 0))
    (setq-local visual-fill-column-center-text t)
    (visual-fill-column-mode -1)
    (visual-fill-column-mode 1)))

(advice-add 'writeroom-mode :around #'my/set-zen-font-before-writeroom)

;; Customize zen mode appearance
(add-hook 'writeroom-mode-hook
          (lambda ()
            (if writeroom-mode
                ;; Hide line numbers in zen mode
                (display-line-numbers-mode -1)
              ;; Restore when exiting zen mode
              (display-line-numbers-mode 1)
              (buffer-face-mode -1)
              (setq-local face-remapping-alist nil))))

;; Auto-enable zen mode for TTRPG org-roam notes
(add-hook 'org-mode-hook
          (lambda ()
            (when (and (buffer-file-name)
                       (string-match-p "/ttrpg/" (buffer-file-name))
                       (not writeroom-mode))
              (writeroom-mode 1))))
#+end_src

** Prettier UI Elements
Modern styling for org-mode elements using org-modern and org-superstar.

#+begin_src emacs-lisp
;; Decluttering & Text Prettification
(after! org
  (setq org-adapt-indentation t
        org-hide-leading-stars t
        org-hide-emphasis-markers t
        org-pretty-entities t
        org-pretty-entities-include-sub-superscripts t
        org-ellipsis "  ·"
        org-src-fontify-natively t
        org-src-tab-acts-natively t
        org-edit-src-content-indentation 0
        ;; LaTeX preview settings
        org-highlight-latex-and-related '(native latex entities)
        org-latex-create-formula-image-program 'dvipng
        org-preview-latex-default-process 'dvipng
        org-format-latex-options (plist-put org-format-latex-options :scale 1.5)))

;; Visual line mode for better text wrapping
(add-hook 'org-mode-hook 'visual-line-mode)

;; Resize Org headings - using JetBrains Mono to maintain font consistency
(after! org
  (dolist (face '((org-level-1 . 1.35)
                  (org-level-2 . 1.3)
                  (org-level-3 . 1.2)
                  (org-level-4 . 1.1)
                  (org-level-5 . 1.1)
                  (org-level-6 . 1.1)
                  (org-level-7 . 1.1)
                  (org-level-8 . 1.1)))
    (set-face-attribute (car face) nil :font "JetBrainsMono Nerd Font" :weight 'bold :height (cdr face)))

  ;; Make the document title bigger
  (set-face-attribute 'org-document-title nil :font "JetBrainsMono Nerd Font" :weight 'bold :height 1.8))

;; Ensure some parts always use fixed-pitch (monospace)
(custom-theme-set-faces
 'user
 '(org-block ((t (:inherit fixed-pitch))))
 '(org-code ((t (:inherit (shadow fixed-pitch)))))
 '(org-indent ((t (:inherit (org-hide fixed-pitch)))))
 '(org-verbatim ((t (:inherit (shadow fixed-pitch)))))
 '(org-special-keyword ((t (:inherit (font-lock-comment-face fixed-pitch)))))
 '(org-meta-line ((t (:inherit (font-lock-comment-face fixed-pitch)))))
 '(org-checkbox ((t (:inherit fixed-pitch)))))

;; org-modern customization (loaded by Doom's +pretty flag)
(after! org-modern
  (setq org-auto-align-tags t
        org-tags-column 0
        org-fold-catch-invisible-edits 'show-and-error
        org-special-ctrl-a/e t
        org-insert-heading-respect-content t
        ;; org-modern: disable star styling (let org-superstar handle it)
        org-modern-star nil
        ;; Agenda styling
        org-agenda-tags-column 0
        org-agenda-block-separator ?─
        org-agenda-time-grid '((daily today require-timed)
                               (800 1000 1200 1400 1600 1800 2000)
                               " ┄┄┄┄┄ " "┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄")
        org-agenda-current-time-string "⭠ now ─────────────────────────────────────────────────")
  ;; Let Doom's pretty.el handle org-modern-todo/priority/tag-faces
  ;; It automatically processes org-todo-keyword-faces and org-priority-faces
  )

;; org-superstar - Better heading bullets and TODO items
(use-package! org-superstar
  :after org
  :config
  (setq org-superstar-leading-bullet " "
        org-superstar-special-todo-items t
        org-superstar-todo-bullet-alist '(("TODO" . 9744)
                                          ("DONE" . 9744)
                                          ("READ" . 9744)
                                          ("IDEA" . 9744)
                                          ("WAITING" . 9744)
                                          ("CANCELLED" . 9744)
                                          ("PROJECT" . 9744)
                                          ("POSTPONED" . 9744)))
  (add-hook 'org-mode-hook 'org-superstar-mode))

;; Custom TODO keywords and colors using Doom theme
(after! org
  ;; Define TODO keywords sequence FIRST
  (setq org-todo-keywords
        '((sequence
           "TODO(t)" "PROJ(p)" "READ(r)" "CHECK(c)" "IDEA(i)" "WAITING(w)"
           "|"
           "DONE(d)" "CANCELLED(k)" "POSTPONED(s)"))))

;; Set TODO keywords and priorities with Catppuccin Mocha colors directly
(after! org
  ;; Priority settings
  (setq org-lowest-priority ?F
        org-default-priority ?E)

  ;; Set org-todo-keyword-faces with Catppuccin Mocha colors
  ;; Swapped fg/bg because org-modern adds :inverse-video t
  (setq org-todo-keyword-faces
        '(("TODO"      . (:foreground "#a6e3a1" :background "#1e1e2e" :weight bold))  ; Green
          ("PROJ"      . (:foreground "#89dceb" :background "#1e1e2e" :weight bold))  ; Sky
          ("READ"      . (:foreground "#89b4fa" :background "#1e1e2e" :weight bold))  ; Blue
          ("CHECK"     . (:foreground "#f9e2af" :background "#1e1e2e" :weight bold))  ; Yellow
          ("IDEA"      . (:foreground "#f5c2e7" :background "#1e1e2e" :weight bold))  ; Pink
          ("WAITING"   . (:foreground "#fab387" :background "#1e1e2e" :weight bold))  ; Peach
          ("DONE"      . (:foreground "#6c7086" :background "#1e1e2e" :weight bold))  ; Surface2
          ("CANCELLED" . (:foreground "#585b70" :background "#1e1e2e" :weight bold))  ; Surface1
          ("POSTPONED" . (:foreground "#45475a" :background "#1e1e2e" :weight bold)))) ; Surface0

  ;; Set org-priority-faces with Catppuccin Mocha colors
  ;; Swapped fg/bg because org-modern adds :inverse-video t
  ;; A (highest) = Red, B = Peach, C = Yellow, D = Green, E = Blue, F (lowest) = Surface
  (setq org-priority-faces
        '((?A . (:foreground "#f38ba8" :background "#1e1e2e" :weight bold))  ; Red - Highest
          (?B . (:foreground "#fab387" :background "#1e1e2e" :weight bold))  ; Peach
          (?C . (:foreground "#f9e2af" :background "#1e1e2e" :weight bold))  ; Yellow
          (?D . (:foreground "#a6e3a1" :background "#1e1e2e" :weight bold))  ; Green
          (?E . (:foreground "#89b4fa" :background "#1e1e2e" :weight bold))  ; Blue
          (?F . (:foreground "#6c7086" :background "#1e1e2e" :weight bold)))) ; Surface - Lowest
)
#+end_src
